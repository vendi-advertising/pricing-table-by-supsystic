tinymce.PluginManager.add("pts_textcolor",function(editor){function getCurrentColor(format){var color;editor.dom.getParents(editor.selection.getStart(),function(elm){var value;if(!color&&(value=elm.style[format=='forecolor'?'color':'background-color'])){color=value}});return color}function applyFormat(format,value){if(editor._ptsColorPickerBookmark){editor.selection.moveToBookmark(editor._ptsColorPickerBookmark)}editor.formatter.apply(format,{value:value})}function onColorSelect(format,color){applyFormat(format,color)}function findBtnEl(panel){if(!panel)return;if(panel._items&&panel._items.length){for(var i=0;i<panel._items.length;i++){if(panel._items[i]._classes&&panel._items[i]._classes[0]&&panel._items[i]._classes[0]=='colorbutton'){return panel._items[i]}var btn=findBtnEl(panel._items[i]);if(btn){return btn}}}return false}function setBtnColor(btn,color){color=color?color:getCurrentColor('forecolor');btn.css({'background-color':color})}var cols,rows,colorPicker=null;rows=editor.settings.textcolor_rows||5;cols=editor.settings.textcolor_cols||8;editor.on('click',function(selection){if(editor.theme){var colorBtn=findBtnEl(editor.theme.panel);if(!colorBtn)return;var btnHtml=null;for(var key in colorBtn._elmCache){btnHtml=colorBtn._elmCache[key];break}setBtnColor(jQuery(btnHtml).find('.ptsColorpickerInput'))}});editor.on('BeforeRenderUI',function(e){var colorBtn=findBtnEl(e.target.theme.panel);if(colorBtn){setTimeout(function(){var btnHtml=null;for(var key in colorBtn._elmCache){btnHtml=colorBtn._elmCache[key];break}jQuery(btnHtml).html('<div class="ptsColorpickerInputShell"><div class="ptsColorpickerInput"></div></div>');setBtnColor(jQuery(btnHtml).find('.ptsColorpickerInput'))},10)}});jQuery(function(){editor.addButton("forecolor",{type:"panelbutton",tooltip:"Text color",format:"forecolor",classes:"colorbutton",panel:{role:"application",ariaRemember:true,html:"",classes:"colorpanel",border:1,onpostrender:function(e){if(!e.control._ptsInited){e.control._ptsFirstTimeChange=true;var $control=jQuery("#"+e.control._id);$control.html("<div class='wpColorPicker'></div>");$control.attr("bottom-panel","cp");var colorPickerOptions=jQuery.extend({color:getCurrentColor("forecolor"),appendTo:$control.find(".wpColorPicker").get(0),renderCallback:function(colors,n){var isFocusHexTextField=$control.find('div.HEX-disp.cp-disp').is(":focus");var colorString='rgba('+colors.webSmart.r+','+colors.webSmart.g+','+colors.webSmart.b+','+colors.alpha+')';e.control._octFirstTimeChange=false;applyFormat("forecolor",colorString);editor._ptsColorPickerBookmark=editor.selection.getBookmark(2,true);jQuery("#"+e.control._parent._id+" .ptsColorpickerInput").css("background-color",colorString);jQuery("#"+e.control._parent._id).trigger("colorpickersliders.updateColor",colorString);if(isFocusHexTextField){$control.find('div.HEX-disp.cp-disp').focus()}}},g_ptsColorPickerOptions);colorPicker=new ColorPicker(colorPickerOptions);e.control._ptsInited=true}},onshow:function(e){editor._ptsColorPickerBookmark=editor.selection.getBookmark(2,true);var currentColor=getCurrentColor("forecolor");if(colorPicker){colorPicker.setColor(currentColor,'rgb');colorPicker.startRender()}jQuery("#"+e.control._parent._id).trigger("colorpickersliders.updateColor",currentColor);jQuery("#"+e.control._id).removeClass("mce-container");var $rootControl=jQuery("#"+e.control.rootControl._id);if($rootControl.hasClass('cp-hideArrow')){$rootControl.addClass("cp-hideArrow")}}}})})});